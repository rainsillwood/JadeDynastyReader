<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Jade Dynasty Element Reader</title>
    <script type="text/javascript">
        var input; //input file
        var buffer = new ArrayBuffer();
        var meta;
        var iindex, ilength;
        var dataArray;

        function parseData() {
            dataArray = {};
            iindex = 8;
            document.getElementById('tph').innerHTML = Object.keys(meta).length;
            for (let i in meta) {
                if (meta[i].constructor == Number) {
                    dataArray[i].offset = iindex;
                    dataArray[i].value = getData(buffer, 'unknown|' + meta[i], iindex);
                    continue;
                }
                document.getElementById('iph').innerHTML = i;
                let dataLength = getData(buffer, 'uint|4', iindex) * 1;
                let dataCount = getData(buffer, 'uint|4', iindex) * 1;
                ilength = 0;
                dataArray[i] = [];
                document.getElementById('tdt').innerHTML = dataCount;
                if (i.includes('NPC介绍')) {
                    alert('~');
                }
                for (let j = 0; j < dataCount; j++) {
                    document.getElementById('idt').innerHTML = j;
                    dataArray[i][j] = {};
                    document.getElementById('tel').innerHTML = Object.keys(meta[i]).length;
                    for (let k in meta[i]) {
                        document.getElementById('iel').innerHTML = k;
                        dataArray[i][j][k] = getData(buffer, meta[i][k], iindex);
                    }
                }
                if (ilength != dataLength * dataCount) {
                    alert(i + ' 数据格式不对');
                    break;
                }
            }
            alert('~');
        }

        function getaMeta() {
            let rawFile = new XMLHttpRequest();
            rawFile.open('GET', './zxdata.txt', false);
            rawFile.send();
            let metaArray = rawFile.responseText.split('\n');
            meta = {};
            let p = 0;
            for (let m in metaArray) {
                let key = metaArray[m].split('<')[1].split(',')[0];
                let elements = metaArray[m].split('{')[1].split('}')[0].split('\t');
                switch (key) {
                    case '传送符': {
                        p = p + 1;
                        meta[(m * 1 + p) + '占位1'] = 24;
                        break;
                    }
                    case 'NPC介绍服务': {
                        p = p + 1;
                        meta[(m * 1 + p) + '占位2'] = 19;
                        break;
                    }
                }
                key = (m * 1 + p + 1) + '_' + key;
                meta[key] = {};
                for (let n in elements) {
                    let ndata = elements[n].split('|');
                    ndata[0] = ndata[0].replace('*', '未知数据');
                    ndata[0] = (n * 1 + 1) + '_' + ndata[0];
                    switch (ndata[1]) {
                        case '0': {
                            ndata[1] = '';
                            break;
                        }
                        case '1': {
                            ndata[1] = 'int';
                            break;
                        }
                        case '2': {
                            ndata[1] = 'int';
                            break;
                        }
                        case '3': {
                            ndata[1] = 'int';
                            break;
                        }
                        case '4': {
                            ndata[1] = 'int';
                            break;
                        }
                        case '5': {
                            ndata[1] = 'float';
                            break;
                        }
                        case '6': {
                            ndata[1] = 'double';
                            break;
                        }
                        case '7': {
                            ndata[1] = 'bool';
                            break;
                        }
                        case '8': {
                            ndata[1] = 'time';
                            break;
                        }
                        case '9': {
                            ndata[1] = 'string';
                            break;
                        }
                        case '10': {
                            ndata[1] = 'ascii';
                            break;
                        }
                        default: {
                            ndata[1] = 'unknown';
                        }
                    }
                    meta[key][ndata[0]] = ndata[1] + '|' + ndata[2];
                }
            }

        }

        function getData(data, type, index) {
            let idata;
            let itype = type.split('|');
            let dataViewer = new DataView(data, index, itype[1] * 1);
            switch (itype[0]) {
                case 'string': {
                    idata = '';
                    for (let x = 0; x < itype[1] / 2; x = x + 2) {
                        if (dataViewer.getUint16(x, true) != 0) idata = idata + String.fromCharCode(dataViewer.getUint16(x, true));
                    }
                    break;
                }
                case 'ascii': {
                    idata = '';
                    for (let x = 0; x < itype[1] * 1; x++) {
                        if (dataViewer.getUint8(x) != 0) idata = idata + String.fromCharCode(dataViewer.getUint16(x));
                    }
                    break;
                }
                case 'uint': {
                    idata = 0;
                    for (let x = 0; x < itype[1] * 1; x++) {
                        idata = idata + dataViewer.getUint8(x) * Math.pow(256, x * 1);
                    }
                    break;
                }
                case 'int': {
                    idata = 0;
                    let bit = itype[1] * 1;
                    for (let x = 0; x < itype[1] * 1; x++) {
                        idata = idata + dataViewer.getUint8(x) * Math.pow(256, x * 1);
                    }
                    if (idata >= ((256 ^ bit) / 2)) idata = idata - 256 ^ bit;
                    break;
                }
                case 'float': {
                    idata = dataViewer.getFloat32(0);
                    break;
                }
                case 'double': {
                    idata = dataViewer.getFloat64(0);
                    break;
                }
                case 'time': {
                    let idate = new Date(dataViewer.getInt32(0) * 1000).toLocaleString().replace(/:\d{1,2}$/, ' ');
                    idata = idate.getFullYear() + ' ' + (idate.getMonth() + 1) + ' ' + idate.getDate() + ' ' + idate.getHours() + ' ' + idate.getMinutes() + ' ' + idate.getSeconds();
                    break;
                }
                case 'bool': {
                    idata = '暂不支持';
                }
                default: {
                    idata = '';
                    for (let x = 0; x < itype[1] * 1; x++) {
                        let char = (dataViewer.getUint8(x) < 16 ? '0' : '') + dataViewer.getUint8(x).toString(16);
                        idata = idata + char;
                    }
                }
            }
            iindex = iindex + itype[1] * 1;
            ilength = ilength + itype[1] * 1;
            return idata;
        }
    </script>
</head>

<body>
    <div>
        <a>段数处理进度：</a><a id="iph"></a><a>/</a><a id="tph"></a></br>
        <a>数据处理进度：</a><a id="idt"></a><a>/</a><a id="tdt"></a></br>
        <a>属性处理进度：</a><a id="iel"></a><a>/</a><a id="tel"></a></br>
    </div>
    <input type="file" name="" id="file" value="" />
    <script>
        input = document.getElementById('file');
        input.onchange = function () {
            var file = this.files[0]; //获取文件
            if (!!file) {
                //读取本地文件
                var reader = new FileReader();
                reader.readAsArrayBuffer(file); //ArrayBuffer对象
                reader.onload = function (e) {
                    //读取完毕后输出结果
                    buffer = e.target.result;
                    getaMeta();
                    parseData();
                }
            }
            this.files[0] = "";
        }
    </script>
    <input type="button" onclick="parseData();" value="处理数据">
</body>

</html>