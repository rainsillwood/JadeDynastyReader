<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Jade Dynasty Element Reader</title>
    <script type="text/javascript">
        var input; //input file
        var buffer = new ArrayBuffer();
        var rawFile = new XMLHttpRequest();
        rawFile.open("GET", "meta.json", false);
        if (rawFile.readyState == 4 && rawFile.status == 200) {
            var meta = JSON.parse(this.responseText);
        }
        var iindex, ilength = 0;
        var dataArray = {};

        function parseData() {
            iindex = 8;
            for (i in meta) {
                let dataLength = getData(buffer, 'uint|4', iindex) * 1;
                let dataCount = getData(buffer, 'uint|4', iindex) * 1;
                ilength = 0;
                dataArray[i] = [];
                for (j = 0; j < dataCount; j++) {
                    dataArray[i][j] = {};
                    for (k in meta[i]) {
                        dataArray[i][j][k] = getData(buffer, meta[i][k], iindex);
                    }
                }
                if (ilength != dataLength * dataCount) {
                    alert(i + ' 数据格式不对');
                }
            }
            alert('~');
        }

        function getData(data, type, index) {
            let idata = '';
            let itype = type.split('|');
            switch (itype[0]) {
                case 'string': {
                    let stringArray = new Uint16Array(data, index, itype[1] / 2);
                    for (x in stringArray) {
                        if (stringArray[x] == 0) continue;
                        idata = idata + String.fromCharCode(stringArray[x]);
                    }
                    break;
                }
                case 'uint': {
                    let inumber = 0;
                    let intArray = new Uint8Array(data, index, itype[1] * 1);
                    for (x in intArray) {
                        inumber = inumber + intArray[x] * Math.pow(256, x * 1);
                    }
                    idata = idata + inumber;
                    break;
                }
                case 'int': {
                    let inumber = 0;
                    let bit = itype[1] * 1;
                    let intArray = new Uint8Array(data, index, itype[1] * 1);
                    for (x in intArray) {
                        inumber = inumber + intArray[x] * Math.pow(256, x * 1);
                    }
                    if (inumber >= ((256 ^ bit) / 2)) inumber = inumber - 256 ^ bit;
                    idata = idata + inumber;
                    break;
                }
                case 'float': {
                    let intArray = new Float32Array(data, index, 1);
                    idata = idata + intArray[0];
                    break;
                }
                case 'double': {
                    let intArray = new Float64Array(data, index, 1);
                    idata = idata + intArray[0];
                    break;
                }
                default: {
                    idata = '暂不支持';
                    break;
                }
            }
            iindex = iindex + itype[1] * 1;
            ilength = ilength + itype[1] * 1;
            return idata;
        }
    </script>
</head>

<body>
    <input type="file" name="" id="file" value="" />
    <script>
        input = document.getElementById('file');
        input.onchange = function () {
            var file = this.files[0]; //获取文件
            if (!!file) {
                //读取本地文件
                var reader = new FileReader();
                reader.readAsArrayBuffer(file); //ArrayBuffer对象
                reader.onload = function (e) {
                    //读取完毕后输出结果
                    buffer = e.target.result;
                    parseData();
                }
            }
        }
    </script>
</body>

</html>